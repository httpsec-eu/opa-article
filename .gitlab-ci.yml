---

variables:
  BUNDLE: "bundle"
  REPO: "./docker"
  TAG: '0.1'

stages:
  - build

Build Rego package:
  stage: build
  image: harbor.httpsec.eu/security/opa-build:0.1
  script:
    - cd ${REPO}
    - opa build --bundle --output ${BUNDLE}.tar.gz .
    - echo '{}' > manifest.conf
    - |
      oras push harbor.httpsec.eu/docker-opa/${BUNDLE}:${TAG} \
        --config manifest.conf:application/vnd.oci.image.config.v1+json \
        ${BUNDLE}.tar.gz:application/vnd.oci.image.layer.v1.tar+gzip
  artifacts:
    name: "bundles"
    paths:
      - ${REPO}/${BUNDLE}.tar.gz
  when: manual
